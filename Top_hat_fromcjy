#include <Arduino.h>
#include <WiFi.h>
#include <WebServer.h>
#include <Wire.h>

// ===================== WiFi AP =====================
const char *ssid     = "ESP32_Joystick_Car";
const char *password = "12345678";
WebServer server(80);

// ===================== I2C =====================
#define I2C_SLAVE_ADDR      0x28
#define SDA_PIN             43
#define SCL_PIN             44
#define COMM_INTERVAL_MS    500   // 2 Hz

// ===================== HP / RUN FLAG =====================
volatile int run_flag = 1;
unsigned long previousMillis = 0;

// ===================== “发包”统计：只统计用户操作 =====================
// 只有用户按按钮/触发cmd才算“扣血包”
volatile uint32_t wifi_packets_window = 0;

// ===================== Motor Stub（你需要自己换成真实电机控制） =====================
void stop_all_motors() {
  Serial.println("ROBOT MOVEMENT DISABLED.");
  // TODO: 在这里写真实停电机（PWM=0 / 刹车等）
}

// ===================== I2C Master (保持你第一份串口风格) =====================
void send_I2C_byte(uint8_t data) {
  Wire.beginTransmission(I2C_SLAVE_ADDR);
  Wire.write(data);
  uint8_t error = Wire.endTransmission();

  if (error == 0) {
    Serial.printf("[%lu ms] SUCCESS: Data sent.\n", millis());
  } else {
    Serial.printf("[%lu ms] ERROR %d: Failed to send data to Top Hat (No ACK).\n", millis(), error);
  }
}

uint8_t receive_I2C_byte() {
  uint8_t bytesReceived = Wire.requestFrom(I2C_SLAVE_ADDR, (uint8_t)1);
  uint8_t current_health_hp = 0;

  if (bytesReceived > 0) {
    while (Wire.available()) {
      current_health_hp = Wire.read();
    }
    Serial.printf("Received HP: 0x%02X (%d HP) ", current_health_hp, current_health_hp);

    if (current_health_hp == 0x00) {
      if (run_flag != 0) Serial.println("-> STATUS: DEAD");
      run_flag = 0;
      stop_all_motors();
    } else {
      if (run_flag != 1) Serial.println("-> STATUS: ALIVE");
      run_flag = 1;
    }
  } else {
    Serial.println("WARNING: Failed to receive health status (0 bytes received).");
    return 0;
  }
  return current_health_hp;
}

// ===================== 用户操作计数（只有这里会扣血） =====================
static inline void count_user_action_packet() {
  wifi_packets_window++;
}

// ===================== Web UI (按钮页面) =====================
const char index_html[] PROGMEM = R"rawliteral(
<!doctype html><html>
<head>
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<meta charset="utf-8">
<title>ESP32 Control</title>
<style>
  body{font-family:Arial;text-align:center;margin:0;padding:12px}
  h2{margin:8px 0}
  .grid{display:grid;grid-template-columns:repeat(3,90px);grid-gap:10px;justify-content:center;margin-top:18px}
  button{height:54px;font-size:16px;border:none;border-radius:10px;background:#007bff;color:white}
  button.gray{background:#444}
  .info{margin-top:16px;font-family:monospace}
</style>
</head>
<body>
<h2>Robot Buttons</h2>

<div class="grid">
  <div></div>
  <button onclick="send('F')">Forward</button>
  <div></div>

  <button onclick="send('L')">Left</button>
  <button class="gray" onclick="send('S')">Stop</button>
  <button onclick="send('R')">Right</button>

  <div></div>
  <button onclick="send('B')">Backward</button>
  <div></div>
</div>

<div class="info">
  <div>Last cmd: <span id="c">-</span></div>
  <div>Status: <span id="st">-</span></div>
</div>

<script>
function send(c){
  document.getElementById("c").innerText=c;
  var xhr=new XMLHttpRequest();
  xhr.onreadystatechange=function(){
    if(this.readyState==4){
      document.getElementById("st").innerText=this.status + " " + this.responseText;
    }
  };
  xhr.open("GET","/cmd?c="+c,true);
  xhr.send();
}
</script>
</body></html>
)rawliteral";

// ===================== Web Handlers =====================
// 注意：/ 和 /status 不计数！只在 /cmd 计数！

void handleRoot() {
  server.send(200, "text/html; charset=utf-8", index_html);
}

void handleStatus() {
  // 不扣血，只给你看状态
  String s = "RUN_FLAG=" + String(run_flag);
  server.send(200, "text/plain", s);
}

void handleCmd() {
  // ✅ 只有用户按按钮才算“发包/扣血”
  count_user_action_packet();

  char c = 'S';
  if (server.hasArg("c") && server.arg("c").length() > 0) c = server.arg("c")[0];

  // DEAD 强制 stop（不管用户按啥）
  if (run_flag == 0) {
    stop_all_motors();
    server.send(200, "text/plain", "DEAD");
    return;
  }

  // TODO: 你在这里写真实动作（电机控制）
  // 现在先回显命令，方便测试
  // if(c=='F'){...} else if(c=='B'){...} else if(c=='L'){...} else if(c=='R'){...} else {stop...}

  server.send(200, "text/plain", String(c));
}

void handleNotFound() {
  server.send(404, "text/plain", "404");
}

// ===================== Setup / Loop =====================
void setup() {
  Serial.begin(115200);

  WiFi.mode(WIFI_AP);
  WiFi.softAP(ssid, password);

  Wire.begin(SDA_PIN, SCL_PIN, 40000);

  server.on("/", handleRoot);
  server.on("/cmd", handleCmd);
  server.on("/status", handleStatus);
  server.onNotFound(handleNotFound);
  server.begin();

  Serial.println("----------------------------------------");
  Serial.println("ESP32 I2C Master initialized (2 Hz).");
  Serial.printf("SDA: %d, SCL: %d\n", SDA_PIN, SCL_PIN);
  Serial.println("----------------------------------------");
  Serial.print("AP IP: ");
  Serial.println(WiFi.softAPIP());
}

void loop() {
  server.handleClient();

  unsigned long currentMillis = millis();
  if (currentMillis - previousMillis >= COMM_INTERVAL_MS) {
    previousMillis = currentMillis;

    // 只上报“用户操作次数”
    uint32_t pk = wifi_packets_window;
    wifi_packets_window = 0;
    uint8_t pk_byte = (pk > 255) ? 255 : (uint8_t)pk;

    Serial.printf("WiFi TX(window): %lu -> send: 0x%02X (%u)\n", pk, pk_byte, pk_byte);

    send_I2C_byte(pk_byte);
    receive_I2C_byte();

    Serial.printf("-> RUN_FLAG: %d\n", run_flag);
    Serial.println("----------------------------------------");
  }
}

