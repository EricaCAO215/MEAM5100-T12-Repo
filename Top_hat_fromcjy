#include <Arduino.h>
#include <WiFi.h>
#include <WebServer.h>
#include <Wire.h>

// ===================== WiFi AP =====================
const char *ssid     = "ESP32_Joystick_Car";
const char *password = "12345678";
WebServer server(80);

// ===================== I2C =====================
#define I2C_SLAVE_ADDR      0x28
#define SDA_PIN             43
#define SCL_PIN             44
#define COMM_INTERVAL_MS    500   // 2 Hz

// ===================== HP / RUN FLAG =====================
volatile int run_flag = 1;
unsigned long previousMillis = 0;

// ===================== “发包”统计：只统计用户操作 =====================
volatile uint32_t wifi_packets_window = 0;

// 只有网页JS会带这个 key，系统后台请求不会带
static const char *ACTION_KEY = "5100";

// ===================== Motor Stub（你换成真实电机控制） =====================
void stop_all_motors() {
  Serial.println("ROBOT MOVEMENT DISABLED.");
  // TODO: stop motors here
}

// ===================== I2C Master (保留你第一份串口风格) =====================
void send_I2C_byte(uint8_t data) {
  Wire.beginTransmission(I2C_SLAVE_ADDR);
  Wire.write(data);
  uint8_t error = Wire.endTransmission();

  if (error == 0) {
    Serial.printf("[%lu ms] SUCCESS: Data sent.\n", millis());
  } else {
    Serial.printf("[%lu ms] ERROR %d: Failed to send data to Top Hat (No ACK).\n", millis(), error);
  }
}

uint8_t receive_I2C_byte() {
  uint8_t bytesReceived = Wire.requestFrom(I2C_SLAVE_ADDR, (uint8_t)1);
  uint8_t current_health_hp = 0;

  if (bytesReceived > 0) {
    while (Wire.available()) current_health_hp = Wire.read();

    Serial.printf("Received HP: 0x%02X (%d HP) ", current_health_hp, current_health_hp);

    if (current_health_hp == 0x00) {
      if (run_flag != 0) Serial.println("-> STATUS: DEAD");
      run_flag = 0;
      stop_all_motors();
    } else {
      if (run_flag != 1) Serial.println("-> STATUS: ALIVE");
      run_flag = 1;
    }
  } else {
    Serial.println("WARNING: Failed to receive health status (0 bytes received).");
    return 0;
  }
  return current_health_hp;
}

// ===================== 只在“真实用户操作”时计数 =====================
static inline bool is_user_action_request() {
  return server.hasArg("k") && server.arg("k") == ACTION_KEY;
}
static inline void count_user_action_packet() {
  wifi_packets_window++;
}

// ===================== Web UI (按钮页面，无轮询) =====================
const char index_html[] PROGMEM = R"rawliteral(
<!doctype html><html>
<head>
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<meta charset="utf-8">
<title>ESP32 Control</title>
<style>
  body{font-family:Arial;text-align:center;margin:0;padding:12px}
  h2{margin:8px 0}
  .grid{display:grid;grid-template-columns:repeat(3,90px);grid-gap:10px;justify-content:center;margin-top:18px}
  button{height:54px;font-size:16px;border:none;border-radius:10px;background:#007bff;color:white}
  button.gray{background:#444}
  .info{margin-top:16px;font-family:monospace}
</style>
</head>
<body>
<h2>Robot Buttons</h2>

<div class="grid">
  <div></div>
  <button onclick="send('F')">Forward</button>
  <div></div>

  <button onclick="send('L')">Left</button>
  <button class="gray" onclick="send('S')">Stop</button>
  <button onclick="send('R')">Right</button>

  <div></div>
  <button onclick="send('B')">Backward</button>
  <div></div>
</div>

<div class="info">
  <div>Last cmd: <span id="c">-</span></div>
  <div>Resp: <span id="st">-</span></div>
</div>

<script>
const KEY = "5100"; // 必须和后端 ACTION_KEY 一致

function send(c){
  document.getElementById("c").innerText=c;
  var xhr=new XMLHttpRequest();
  xhr.onreadystatechange=function(){
    if(this.readyState==4){
      document.getElementById("st").innerText=this.status + " " + this.responseText;
    }
  };
  xhr.open("GET","/cmd?c="+c+"&k="+KEY,true);
  xhr.send();
}
</script>
</body></html>
)rawliteral";

// ===================== Web Handlers =====================
// / 和各种探测请求：都不计数，不扣血
void handleRoot() {
  server.sendHeader("Cache-Control", "no-store");
  server.send(200, "text/html; charset=utf-8", index_html);
}

// 常见系统探测（不扣血）
void handle204() { server.send(204, "text/plain", ""); }                 // Android
void handleHotspotDetect() { server.send(200, "text/html", "OK"); }      // iOS/macOS
void handleConnectTest() { server.send(200, "text/plain", "Microsoft"); }// Windows
void handleFavicon() { server.send(204, "image/x-icon", ""); }           // favicon

// 只在 /cmd 且带 key 才计数扣血
void handleCmd() {
  char c = 'S';
  if (server.hasArg("c") && server.arg("c").length() > 0) c = server.arg("c")[0];

  // ✅ 只有网页JS带 k=5100 才计数
  if (is_user_action_request()) {
    count_user_action_packet();
  }

  // DEAD 强制 stop
  if (run_flag == 0) {
    stop_all_motors();
    server.send(200, "text/plain", "DEAD");
    return;
  }

  // TODO: 在这里写真实电机动作
  // if(c=='F'){...} else if(c=='B'){...} else if(c=='L'){...} else if(c=='R'){...} else {stop...}

  server.send(200, "text/plain", String(c));
}

void handleNotFound() {
  // 不扣血
  server.send(404, "text/plain", "404");
}

// ===================== Setup / Loop =====================
void setup() {
  Serial.begin(115200);

  WiFi.mode(WIFI_AP);
  WiFi.softAP(ssid, password);

  Wire.begin(SDA_PIN, SCL_PIN, 40000);

  server.on("/", handleRoot);
  server.on("/cmd", handleCmd);

  // 常见联网探测路径（全都不扣血）
  server.on("/generate_204", handle204);
  server.on("/hotspot-detect.html", handleHotspotDetect);
  server.on("/connecttest.txt", handleConnectTest);
  server.on("/favicon.ico", handleFavicon);

  server.onNotFound(handleNotFound);
  server.begin();

  Serial.println("----------------------------------------");
  Serial.println("ESP32 I2C Master initialized (2 Hz).");
  Serial.printf("SDA: %d, SCL: %d\n", SDA_PIN, SCL_PIN);
  Serial.println("----------------------------------------");
  Serial.print("AP IP: ");
  Serial.println(WiFi.softAPIP());
}

void loop() {
  server.handleClient();

  unsigned long currentMillis = millis();
  if (currentMillis - previousMillis >= COMM_INTERVAL_MS) {
    previousMillis = currentMillis;

    uint32_t pk = wifi_packets_window;
    wifi_packets_window = 0;
    uint8_t pk_byte = (pk > 255) ? 255 : (uint8_t)pk;

    Serial.printf("WiFi TX(window): %lu -> send: 0x%02X (%u)\n", pk, pk_byte, pk_byte);

    send_I2C_byte(pk_byte);
    receive_I2C_byte();

    Serial.printf("-> RUN_FLAG: %d\n", run_flag);
    Serial.println("----------------------------------------");
  }
}
