#include <Arduino.h>
#include <WiFi.h>
#include <WebServer.h>
#include <Wire.h>

// ===================== WiFi AP =====================
const char *ssid     = "ESP32_Joystick_Car";
const char *password = "12345678";
WebServer server(80);

// ===================== I2C =====================
#define I2C_SLAVE_ADDR      0x28
#define SDA_PIN             43
#define SCL_PIN             44
#define COMM_INTERVAL_MS    500

// ===================== Counters =====================
// 用“HTTP请求数”近似 WiFi 发送包数量（window内）
volatile uint32_t wifi_tx_count_window = 0;   // 每500ms清零一次
volatile uint32_t wifi_tx_count_total  = 0;

// ===================== Run Flag / HP =====================
volatile int run_flag = 1;
unsigned long previousMillis = 0;

// ===================== Motor Stub =====================
void stop_all_motors() {
  // TODO: 你在这里放真实停电机代码
  Serial.println("ROBOT MOVEMENT DISABLED.");
}

// ===================== Web UI =====================
const char index_html[] PROGMEM = R"rawliteral(
<!doctype html><html>
<head>
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<meta charset="utf-8">
<title>ESP32 Control</title>
<style>
  body{font-family:Arial;text-align:center;margin:0;padding:12px}
  h2{margin:8px 0}
  .grid{display:grid;grid-template-columns:repeat(3,90px);grid-gap:10px;justify-content:center;margin-top:18px}
  button{height:54px;font-size:16px;border:none;border-radius:10px;background:#007bff;color:white}
  button.gray{background:#444}
  .info{margin-top:16px;font-family:monospace}
</style>
</head>
<body>
<h2>Robot Buttons</h2>

<div class="grid">
  <div></div>
  <button onclick="send('F')">Forward</button>
  <div></div>

  <button onclick="send('L')">Left</button>
  <button class="gray" onclick="send('S')">Stop</button>
  <button onclick="send('R')">Right</button>

  <div></div>
  <button onclick="send('B')">Backward</button>
  <div></div>
</div>

<div class="info">
  <div>Last cmd: <span id="c">-</span></div>
  <div>Ping: <span id="p">-</span></div>
</div>

<script>
function send(c){
  document.getElementById("c").innerText=c;
  var xhr=new XMLHttpRequest();
  xhr.open("GET","/cmd?c="+c,true);
  xhr.send();
}

// 轮询一下，确保有持续HTTP traffic（可删）
setInterval(function(){
  var xhr=new XMLHttpRequest();
  xhr.onreadystatechange=function(){
    if(this.readyState==4 && this.status==200){
      document.getElementById("p").innerText=Date.now();
    }
  };
  xhr.open("GET","/ping",true);
  xhr.send();
}, 500);
</script>
</body></html>
)rawliteral";

// ===================== Helpers =====================
static inline void count_wifi_tx() {
  wifi_tx_count_total++;
  wifi_tx_count_window++;
}

// ===================== I2C =====================
void send_I2C_byte(uint8_t data) {
  Wire.beginTransmission(I2C_SLAVE_ADDR);
  Wire.write(data);
  uint8_t error = Wire.endTransmission();

  if (error == 0) {
    Serial.printf("[%lu ms] SUCCESS: Data sent.\n", millis());
  } else {
    Serial.printf("[%lu ms] ERROR %d: Failed to send data to Top Hat (No ACK).\n", millis(), error);
  }
}

uint8_t receive_I2C_byte() {
  uint8_t bytesReceived = Wire.requestFrom(I2C_SLAVE_ADDR, (uint8_t)1);
  uint8_t current_health_hp = 0;

  if (bytesReceived > 0) {
    while (Wire.available()) {
      current_health_hp = Wire.read();
    }
    Serial.printf("Received HP: 0x%02X (%d HP) ", current_health_hp, current_health_hp);

    if (current_health_hp == 0x00) {
      if (run_flag != 0) Serial.println("-> STATUS: DEAD");
      run_flag = 0;
      stop_all_motors();
    } else {
      if (run_flag != 1) Serial.println("-> STATUS: ALIVE");
      run_flag = 1;
    }
  } else {
    Serial.println("WARNING: Failed to receive health status (0 bytes received).");
    return 0;
  }
  return current_health_hp;
}

// ===================== Web Handlers =====================
void handleRoot() {
  count_wifi_tx();
  server.send(200, "text/html; charset=utf-8", index_html);
}

void handlePing() {
  count_wifi_tx();
  server.send(200, "text/plain", "OK");
}

void handleCmd() {
  count_wifi_tx();

  // 读取按钮命令（你可以在这里接入电机控制）
  char c = 'S';
  if (server.hasArg("c") && server.arg("c").length() > 0) c = server.arg("c")[0];

  // 如果 DEAD，强制 stop
  if (run_flag == 0) c = 'S';

  // TODO: 在这里根据 c 做前进/后退/转向/停止
  // if(c=='F'){...} else if(c=='B'){...} ...

  server.send(200, "text/plain", "OK");
}

void handleNotFound() {
  count_wifi_tx();
  server.send(404, "text/plain", "404");
}

// ===================== Setup / Loop =====================
void setup() {
  Serial.begin(115200);

  WiFi.mode(WIFI_AP);
  WiFi.softAP(ssid, password);

  Wire.begin(SDA_PIN, SCL_PIN, 40000);

  server.on("/", handleRoot);
  server.on("/ping", handlePing);
  server.on("/cmd", handleCmd);
  server.onNotFound(handleNotFound);
  server.begin();

  Serial.println("----------------------------------------");
  Serial.println("ESP32 I2C Master initialized (2 Hz).");
  Serial.printf("SDA: %d, SCL: %d\n", SDA_PIN, SCL_PIN);
  Serial.println("----------------------------------------");
}

void loop() {
  server.handleClient();

  unsigned long currentMillis = millis();
  if (currentMillis - previousMillis >= COMM_INTERVAL_MS) {
    previousMillis = currentMillis;

    // 1) 取窗口计数 -> 作为 wifi 发送包数量(近似)
    uint32_t pk = wifi_tx_count_window;
    wifi_tx_count_window = 0;
    uint8_t pk_byte = (pk > 255) ? 255 : (uint8_t)pk;

    Serial.printf("WiFi TX(window): %lu -> sendByte: 0x%02X (%u)\n", pk, pk_byte, pk_byte);

    // 2) 发给从机
    send_I2C_byte(pk_byte);

    // 3) 收HP并更新run_flag
    receive_I2C_byte();

    // 4) 打印 run_flag
    Serial.printf("-> RUN_FLAG: %d\n", run_flag);
    Serial.println("----------------------------------------");
  }
}
