/*
*Board:ESP32-S2(Master)*Role:Web Server+Sensor Logic*Wiring:TX->17,RX->18*/
// ===================== 1. 包含的头文件 =====================
#include<Wire.h>
#include<VL53L0X.h>
#include<HardwareSerial.h>
#include<WiFi.h>
#include<WebServer.h>

// ===================== 2. 全局定义和变量 =====================
// I2C (ToF)
#define MY_SDA 8
#define MY_SCL 9

// US-100 超声波 (使用 UART1)
const int US100_RX_PIN=44;
const int US100_TX_PIN=43;

// 板间通信 (连 C3) - 映射 Serial0 到 17/18
const int COMM_TX_PIN=17; // 连 C3 的 RX(8)
const int COMM_RX_PIN=18; // 连 C3 的 TX(10)
HardwareSerial CommSerial(0);

// 变量与对象
VL53L0X tofSensor;
HardwareSerial US100Serial(1);
WebServer server(80);

// WiFi 配置
const char*ssid="ESP32_Robot_Master";
const char*password="12345678";
IPAddress local_ip(192,168,10,1);
IPAddress gateway(192,168,10,1);
IPAddress subnet(255,255,255,0);

// 数据存储
float val_front=0.0;
float val_side=0.0;
float rpm_m1=0.0;
float rpm_m2=0.0;
bool obs_front=false;

// 传感器计时
unsigned long lastUS100Time=0;
bool waitingForUS100=false;

// 函数原型声明
void handleRoot();
void handleJoy();
void handleData();
void parseC3Feedback();
void setup();
void loop();

// ===================== 3. 网页代码 (HTML/JS) =====================
const char index_html[]PROGMEM=R"rawliteral(
<!DOCTYPE HTML><html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<meta charset="utf-8">
<title>ROBA Master</title>
<style>
body { font-family: sans-serif; text-align: center; margin:0; background: #f4f4f4; color: #333; touch-action: none; }
h2 { margin: 15px 0; color: #444; }

.panel { display: flex; justify-content: center; gap: 15px; margin: 20px; }
.card { background: #fff; padding: 15px; border-radius: 12px; width: 45%; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
.val { font-size: 2rem; font-weight: bold; color: #2c3e50; }
.lbl { font-size: 0.9rem; color: #7f8c8d; margin-bottom: 5px; }

.danger { border: 3px solid #e74c3c; background: #fadbd8; }
.safe { border: 3px solid #2ecc71; }

#joy-zone {
position: relative; width: 240px; height: 240px; margin: 20px auto;
background: #dde; border-radius: 50%; border: 4px solid #bbb;
box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
}
#joy-knob {
position: absolute; width: 80px; height: 80px; background: #3498db;
border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%);
box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}
.rpm { font-family: monospace; font-size: 1.2rem; margin-top: 20px; color: #555; }
</style>
</head>
<body>
<h2>ROBA Master Control</h2>

<div class="panel">
<div id="c-front" class="card safe">
<div class="lbl">FRONT (ToF)</div>
<div id="v-front" class="val">--</div>
</div>
<div id="c-side" class="card safe">
<div class="lbl">SIDE (US)</div>
<div id="v-side" class="val">--</div>
</div>
</div>

<div id="joy-zone"><div id="joy-knob"></div></div>

<div class="rpm">
L: <span id="r1">0</span> | R: <span id="r2">0</span>
</div>

<script>
var zone = document.getElementById("joy-zone");
var knob = document.getElementById("joy-knob");
var maxR = 80;
var rect, cx, cy, drag=false, lastT=0;

function setRect(){ rect=zone.getBoundingClientRect(); cx=rect.width/2; cy=rect.height/2; }
setRect(); window.onresize=setRect;

function start(e){ drag=true; e.preventDefault(); }
function end(){ drag=false; knob.style.transform="translate(-50%,-50%)"; send(0,0); }
function move(e){
if(!drag)return; e.preventDefault();
var tx=e.touches?e.touches[0].clientX:e.clientX;
var ty=e.touches?e.touches[0].clientY:e.clientY;
var x=tx-rect.left-cx; var y=ty-rect.top-cy;
var d=Math.sqrt(x*x+y*y);
if(d>maxR){ var a=Math.atan2(y,x); x=Math.cos(a)*maxR; y=Math.sin(a)*maxR; }
knob.style.transform=`translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;

if(Date.now()-lastT>100){
send(Math.round(x/maxR*100), Math.round(y/maxR*-100));
lastT=Date.now();
}
}

zone.addEventListener("mousedown",start); zone.addEventListener("touchstart",start);
document.addEventListener("mousemove",move); document.addEventListener("touchmove",move);
document.addEventListener("mouseup",end); document.addEventListener("touchend",end);

function send(x,y){ fetch("/joy?x="+x+"&y="+y); }

setInterval(()=>{
fetch("/data").then(r=>r.json()).then(d=>{
document.getElementById("v-front").innerText = d.f.toFixed(1);
document.getElementById("v-side").innerText = d.s.toFixed(1);
document.getElementById("r1").innerText = d.m1.toFixed(1);
document.getElementById("r2").innerText = d.m2.toFixed(1);

document.getElementById("c-front").className = d.f < 20.0 ? "card danger" : "card safe";
document.getElementById("c-side").className = d.s < 16.0 ? "card danger" : "card safe";
});
}, 200);
</script>
</body>
</html>
)rawliteral";

// ===================== 4. 函数实现 =====================

void handleRoot(){server.send(200,"text/html",index_html);}

void handleJoy(){
if(server.hasArg("x")){
int x=server.arg("x").toInt();
int y=server.arg("y").toInt();
if(obs_front&&y>0)y=0;
CommSerial.printf("JOY:%d,%d\n",x,y);
server.send(200,"text/plain","OK");
}
}

void handleData(){
String json="{";
json+="\"f\":"+String(val_front)+",";
json+="\"s\":"+String(val_side)+",";
json+="\"m1\":"+String(rpm_m1)+",";
json+="\"m2\":"+String(rpm_m2);
json+="}";
server.send(200,"application/json",json);
}

void parseC3Feedback(){
while(CommSerial.available()){
String line=CommSerial.readStringUntil('\n');
if(line.startsWith("FB:")){
int comma=line.indexOf(',');
if(comma>0){
String s1=line.substring(3,comma);
String s2=line.substring(comma+1);
rpm_m1=s1.toFloat();
rpm_m2=s2.toFloat();
}
}
}
}

void setup(){
CommSerial.begin(115200,SERIAL_8N1,COMM_RX_PIN,COMM_TX_PIN);
WiFi.softAPConfig(local_ip,gateway,subnet);
WiFi.softAP(ssid,password);
server.on("/",handleRoot);
server.on("/joy",handleJoy);
server.on("/data",handleData);
server.begin();
Wire.begin(MY_SDA,MY_SCL);
tofSensor.init();
tofSensor.setTimeout(500);
tofSensor.setSignalRateLimit(0.1);
tofSensor.setMeasurementTimingBudget(50000);

// 【最终修复】使用 VL53L0X::命名空间 和 正确的常量名 (VcselPeriod)
tofSensor.setVcselPulsePeriod(VL53L0X::VcselPeriodPreRange,18);
tofSensor.setVcselPulsePeriod(VL53L0X::VcselPeriodFinalRange,14);

US100Serial.begin(9600,SERIAL_8N1,US100_RX_PIN,US100_TX_PIN);
}

void loop(){
server.handleClient();
parseC3Feedback();
unsigned long now=millis();
uint16_t mm=tofSensor.readRangeSingleMillimeters();
if(!tofSensor.timeoutOccurred())val_front=mm/10.0;
else val_front=-1.0;
obs_front=(val_front>0&&val_front<20.0);
if(!waitingForUS100&&(now-lastUS100Time>=100)){
while(US100Serial.available())US100Serial.read();
US100Serial.write(0x55);
lastUS100Time=now;
waitingForUS100=true;
}
if(waitingForUS100){
if(US100Serial.available()>=2){
unsigned int h=US100Serial.read();
unsigned int l=US100Serial.read();
unsigned int dist=(h*256)+l;
if(dist>0&&dist<4500)val_side=dist/10.0;
waitingForUS100=false;
}
if(now-lastUS100Time>50)waitingForUS100=false;
}
}
